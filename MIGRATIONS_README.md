# Управление миграциями базы данных

Этот документ описывает, как работать с миграциями базы данных в проекте ads_stat.

## Структура миграций

- `alembic/` - директория с конфигурацией Alembic
- `alembic/versions/` - директория с файлами миграций
- `alembic/env.py` - конфигурация окружения для миграций
- `alembic.ini` - основной конфигурационный файл Alembic

## Текущая миграция

**001_initial_schema.py** - базовая миграция, создающая все необходимые таблицы:
- `users` - таблица пользователей с полями для Telegram, Google и VK интеграции
- `reports` - таблица отчетов

## Скрипты для работы с миграциями

### 1. test_migrations.py
Проверяет работоспособность миграций:
```bash
python test_migrations.py
```

### 2. apply_migrations.py
Управляет миграциями:
```bash
# Показать статус миграций
python apply_migrations.py

# Проверить статус
python apply_migrations.py --check

# Применить все миграции
python apply_migrations.py --apply

# Применить до конкретной ревизии
python apply_migrations.py --apply --target 001_initial_schema

# Полная пересборка базы данных
python apply_migrations.py --reset
```

### 3. startup.sh
Автоматически пересобирает базу данных при запуске в продакшене.

## Основные команды Alembic

### Проверка статуса
```bash
alembic current    # Текущая ревизия
alembic history    # История миграций
alembic check      # Проверка подключения к БД
```

### Применение миграций
```bash
alembic upgrade head           # Применить все миграции
alembic upgrade 001_initial_schema  # Применить до конкретной ревизии
alembic downgrade -1           # Откатить на одну ревизию назад
```

### Создание новых миграций
```bash
# Автогенерация на основе изменений в моделях
alembic revision --autogenerate -m "описание изменений"

# Создание пустой миграции
alembic revision -m "описание изменений"
```

## Настройка базы данных

### Переменные окружения
Убедитесь, что в `.env` файле правильно настроен `DATABASE_URL`:
```
DATABASE_URL=postgresql://user:password@localhost/ads_stat
```

### Права доступа
Пользователь базы данных должен иметь права на:
- Создание таблиц
- Создание индексов
- Удаление схемы (для полной пересборки)

## Процесс разработки

### 1. Изменение моделей
При изменении моделей в `app/models/`:

1. Внесите изменения в модели
2. Создайте новую миграцию:
   ```bash
   alembic revision --autogenerate -m "добавлено поле X в таблицу Y"
   ```
3. Проверьте сгенерированную миграцию в `alembic/versions/`
4. Примените миграцию:
   ```bash
   alembic upgrade head
   ```

### 2. Тестирование миграций
```bash
python test_migrations.py
```

### 3. Откат изменений (если нужно)
```bash
alembic downgrade -1
```

## Продакшен деплой

При деплое в продакшен используется `startup.sh`, который:
1. Удаляет существующую схему базы данных
2. Создает новую схему
3. Применяет все миграции
4. Запускает приложение

## Устранение проблем

### Ошибка подключения к базе данных
1. Проверьте, что база данных запущена
2. Убедитесь, что `DATABASE_URL` правильный
3. Проверьте права доступа пользователя

### Конфликты миграций
1. Проверьте историю миграций: `alembic history`
2. Убедитесь, что нет дублирующихся ревизий
3. При необходимости выполните полную пересборку: `python apply_migrations.py --reset`

### Ошибки при применении миграций
1. Проверьте логи ошибок
2. Убедитесь, что модели соответствуют миграции
3. При необходимости откатитесь на предыдущую ревизию: `alembic downgrade -1`

## Модели базы данных

### User (users)
- `id` - первичный ключ
- `telegram_id` - ID пользователя в Telegram
- `username` - имя пользователя
- `first_name`, `last_name` - имя и фамилия
- `email` - email адрес
- `is_active` - активен ли пользователь
- `google_access_token`, `google_refresh_token` - токены Google
- `google_sheet_id` - ID Google таблицы
- `vk_id` - ID пользователя в VK
- `vk_access_token`, `vk_refresh_token` - токены VK
- `has_google_account`, `has_vk_account`, `has_google_sheet` - флаги интеграций

### Report (reports)
- `id` - первичный ключ
- `user_id` - внешний ключ на пользователя
- `name` - название отчета
- `data` - данные отчета в формате JSON

## Индексы

Созданы индексы для оптимизации запросов:
- `ix_users_email` - уникальный индекс по email
- `ix_users_telegram_id` - уникальный индекс по telegram_id
- `ix_users_vk_id` - уникальный индекс по vk_id
- `ix_users_username` - индекс по username
- `ix_reports_id` - индекс по id отчета 