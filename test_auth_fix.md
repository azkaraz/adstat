# Исправления проблемы с бесконечным циклом авторизации

## Проблема
В логах наблюдался бесконечный цикл авторизации с ошибкой 429 (Too Many Requests), что приводило к:
- Множественным повторным запросам авторизации
- Ошибкам 429 от сервера
- Плохому пользовательскому опыту

## Причины
1. **Неправильный API_BASE_URL в продакшене** - указывал на GitHub Pages вместо бэкенда
2. **Бесконечный цикл в useEffect** - зависимости вызывали повторные запуски эффекта
3. **Отсутствие защиты от повторных запросов** - не было механизма предотвращения дублирования

## Исправления

### 1. Исправлен API_BASE_URL
```typescript
// Было:
export const API_BASE_URL = environment === 'production'
  ? 'https://azkaraz.github.io/adstat' // ❌ Неправильно

// Стало:
export const API_BASE_URL = environment === 'production'
  ? 'https://005a-185-161-251-62.ngrok-free.app' // ✅ Правильно
```

### 2. Добавлена защита от бесконечного цикла
В `TelegramAuthInitializer`:
- Добавлен флаг `hasAttemptedAuth` для отслеживания попыток
- Убраны зависимости из `useEffect` - теперь запускается только один раз
- Добавлена проверка на уже авторизованного пользователя

### 3. Добавлена защита от повторных запросов
В `authService.ts`:
- Добавлены флаги `_authInProgress` и `_authPromise`
- Если запрос уже выполняется, возвращается существующий Promise
- Добавлена обработка ошибки 429 с автоматическим повтором

### 4. Улучшена обработка ошибок
В `Login.tsx`:
- Добавлены информативные сообщения об ошибках
- Добавлена обработка различных типов ошибок (429, Network Error)
- Улучшен UI с индикаторами загрузки

## Тестирование

### 1. Проверка исправления бесконечного цикла
1. Откройте приложение в браузере
2. Откройте консоль разработчика (F12)
3. Перейдите на страницу `/login`
4. Убедитесь, что в логах нет повторяющихся сообщений об авторизации

### 2. Проверка правильного API URL
1. В консоли найдите сообщение "API Base URL:"
2. Убедитесь, что URL указывает на правильный бэкенд
3. Проверьте, что запросы идут на правильный адрес

### 3. Проверка обработки ошибок
1. Попробуйте авторизоваться
2. Если возникнет ошибка 429, убедитесь, что:
   - Показывается информативное сообщение
   - Происходит автоматический повтор с задержкой
   - Кнопка авторизации блокируется во время загрузки

### 4. Проверка защиты от повторных запросов
1. Быстро нажмите кнопку авторизации несколько раз
2. Убедитесь, что отправляется только один запрос
3. Проверьте логи на наличие сообщения "Уже есть активный запрос авторизации"

## Ожидаемый результат
- Нет бесконечных циклов авторизации
- Правильные запросы к бэкенду
- Информативные сообщения об ошибках
- Плавный пользовательский опыт
- Защита от дублирования запросов 