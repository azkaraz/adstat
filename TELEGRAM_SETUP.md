# Настройка автоматической аутентификации в Telegram Mini App

## Проблема
При открытии Telegram Mini App через кнопку в боте пользователь должен автоматически авторизоваться, но этого не происходит.

## Решение

### 1. Настройка бота в BotFather

1. Откройте [@BotFather](https://t.me/botfather) в Telegram
2. Создайте нового бота или используйте существующего
3. Выполните команду `/newapp` или `/setmenubutton`
4. Выберите вашего бота
5. Укажите URL вашего приложения (например, `https://azkaraz.github.io/ads_stat`)
6. Укажите текст кнопки (например, "Открыть приложение")

### 2. Настройка Mini App в BotFather

1. Выполните команду `/newapp`
2. Выберите вашего бота
3. Укажите название приложения
4. Укажите короткое описание
5. Загрузите иконку приложения (512x512px)
6. Укажите URL приложения
7. Укажите URL для тестирования (если нужно)

### 3. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
# Telegram Bot Token
TELEGRAM_BOT_TOKEN=your_bot_token_here

# Другие настройки...
```

### 4. Проверка конфигурации

Убедитесь, что в `app/core/config.py` настроен `TELEGRAM_BOT_TOKEN`:

```python
TELEGRAM_BOT_TOKEN: str = "your_bot_token_here"
```

### 5. Как работает автоматическая аутентификация

1. **Инициализация WebApp**: При загрузке приложения инициализируется Telegram WebApp
2. **Получение данных**: Из `window.Telegram.WebApp.initDataUnsafe` получаются данные пользователя
3. **Автоматическая авторизация**: Данные отправляются на бэкенд для создания JWT токена
4. **Сохранение токена**: Токен сохраняется в localStorage для последующих запросов

### 6. Отладка

#### Проверка данных Telegram WebApp

Откройте страницу `/test` в вашем приложении для проверки:

1. Откройте консоль браузера (F12)
2. Проверьте логи инициализации
3. Убедитесь, что данные пользователя доступны

#### Проверка бэкенда

В логах бэкенда должны появиться сообщения:

```
DEBUG: telegram_auth called with data: {...}
DEBUG: Verifying Telegram auth...
DEBUG: Telegram auth verification passed
DEBUG: Auth successful, returning response
```

### 7. Возможные проблемы

#### Проблема: "Telegram WebApp not available"
**Решение**: Убедитесь, что приложение открывается через Telegram, а не напрямую в браузере.

#### Проблема: "No Telegram user data available"
**Решение**: Проверьте настройки бота в BotFather и убедитесь, что Mini App правильно настроен.

#### Проблема: "Telegram auth verification failed"
**Решение**: 
1. Проверьте правильность `TELEGRAM_BOT_TOKEN`
2. Убедитесь, что токен соответствует боту, который открывает приложение

#### Проблема: CORS ошибки
**Решение**: Добавьте домен вашего приложения в `ALLOWED_HOSTS` в `app/core/config.py`:

```python
ALLOWED_HOSTS: List[str] = [
    "http://localhost:3000", 
    "http://localhost:8000",
    "https://azkaraz.github.io",
    "https://your-ngrok-url.ngrok-free.app"
]
```

### 8. Тестирование

1. **Локальное тестирование**:
   - Запустите бэкенд: `python run_backend.py`
   - Запустите фронтенд: `cd frontend && npm run dev`
   - Откройте приложение через ngrok URL

2. **Продакшн тестирование**:
   - Деплойте фронтенд на GitHub Pages
   - Убедитесь, что бэкенд доступен через ngrok
   - Протестируйте через кнопку в боте

### 9. Структура данных

#### Данные от Telegram WebApp:
```javascript
{
  initData: "query_id=...&user=...&auth_date=...&hash=...",
  initDataUnsafe: {
    user: {
      id: 123456789,
      first_name: "Имя",
      last_name: "Фамилия",
      username: "username",
      photo_url: "https://..."
    }
  }
}
```

#### Данные для авторизации:
```javascript
{
  id: 123456789,
  first_name: "Имя",
  last_name: "Фамилия",
  username: "username",
  photo_url: "https://...",
  auth_date: 1234567890,
  hash: "query_id=...&user=...&auth_date=...&hash=..."
}
```

### 10. Безопасность

- Всегда проверяйте подпись от Telegram на бэкенде
- Не доверяйте данным, которые приходят только с фронтенда
- Используйте HTTPS в продакшене
- Храните токены в безопасном месте

## Заключение

После правильной настройки пользователи будут автоматически авторизоваться при открытии вашего Telegram Mini App через кнопку в боте. Если проблемы остаются, проверьте логи в консоли браузера и в бэкенде для диагностики. 